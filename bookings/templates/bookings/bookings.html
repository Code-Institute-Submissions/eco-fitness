{% extends "base.html" %} 
{% load static %} 

{% block page_header %}
<div class="container header-container">
  <div class="row">
    <div class="col"></div>
  </div>
</div>
{% endblock %} 

{% block content %}
<div class="container overlay rounded">
  <div class="row">
    <div class="col-12">
      <p>
        Please see session options below to speak with one of our experts for
        diet plans
      </p>
      <div class="col-12">
        <div class="table-responsive rounded">
          <table class="table table-sm table-borderless">
            <thead class="text-black">
              <tr>
                <th scope="col">Session type</th>
                <th scope="col">duration</th>
                <th scope="col">Expert</th>
                <th scope="col">Price</th>
              </tr>
            </thead>
            {% for booking in bookings %}
            <tr>
              <td class="py-3">
                <p class="my-0"><strong>{{ booking.name }}</strong></p>
              </td>
              <td class="py-3">
                <p class="my-0">{{ booking.length }}</p>
              </td>
              <td class="py-3">
                <p class="my-0">{{ booking.Expert.friendly_name }}</p>
              </td>
              <td class="py-3">
                <p class="my-0">Â£{{ booking.price }}</p>
              </td>
              <td class="py-3">
                    {% if request.user.is_superuser %}
                        <small class="ml-3">
                            <a href="{% url 'edit_session' session.id %}">Edit</a> | 
                            <a class="text-danger" href="{% url 'delete_session' session.id %}">Delete</a>
                        </small>
                    {% endif %}
                <form
                  class="form"
                  action="{% url 'add_to_bag' booking.id %}"
                  method="POST">
                  {% csrf_token %}
                  <div class="form-row">
                    <div class="col-12">
                      <p class="mt-3"><strong>Quantity:</strong></p>
                      <div class="form-group w-50">
                        <div class="input-group">
                          <div class="input-group-prepend">
                            <button
                              class="decrement-qty btn btn-black rounded-0"
                              data-food_id="{{ booking.id }}"
                              id="decrement-qty_{{ booking.id }}"
                            >
                              <span class="icon">
                                <i class="fas fa-minus"></i>
                              </span>
                            </button>
                          </div>
                          <input
                            class="form-control qty_input"
                            type="number"
                            name="quantity"
                            value="1"
                            min="1"
                            max="99"
                            data-booking_id="{{ booking.id }}"
                            id="id_qty_{{ booking.id }}"
                          />
                          <div class="input-group-append">
                            <button
                              class="increment-qty btn btn-black rounded-0"
                              data-booking_id="{{ booking.id }}"
                              id="increment-qty_{{ booking.id }}"
                            >
                              <span class="icon">
                                <i class="fas fa-plus"></i>
                              </span>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="col-12">
                      <input
                        type="submit"
                        class="btn btn-black rounded-0 text-uppercase mt-5"
                        value="Add to Bag"
                      />
                    </div>
                    <input
                      type="hidden"
                      name="redirect_url"
                      value="{{ request.path }}"
                    />
                  </div>
                </form>
              </td>
            </tr>
            {% endfor %}
          </table>
        </div>
      </div>
    </div>
  </div>
  {% endblock %} 

  {% block postloadjs %} 
  {{ block.super }}
  <script type="text/javascript">
    // script used from code institute boutique ado project

    // Disable +/- buttons outside 1-99 range
    function handleEnableDisable(itemId) {
      var currentValue = parseInt($(`#id_qty_${itemId}`).val());
      var minusDisabled = currentValue < 2;
      var plusDisabled = currentValue > 98;
      $(`#decrement-qty_${itemId}`).prop("disabled", minusDisabled);
      $(`#increment-qty_${itemId}`).prop("disabled", plusDisabled);
    }

    // Ensure proper enabling/disabling of all inputs on page load
    var allQtyInputs = $(".qty_input");
    for (var i = 0; i < allQtyInputs.length; i++) {
      var itemId = $(allQtyInputs[i]).data("booking_id");
      handleEnableDisable(itemId);
    }

    // Check enable/disable every time the input is changed
    $(".qty_input").change(function () {
      var itemId = $(this).data("booking_id");
      handleEnableDisable(itemId);
    });

    // Increment quantity
    $(".increment-qty").click(function (e) {
      e.preventDefault();
      var closestInput = $(this).closest(".input-group").find(".qty_input")[0];
      var currentValue = parseInt($(closestInput).val());
      $(closestInput).val(currentValue + 1);
      var itemId = $(this).data("booking_id");
      handleEnableDisable(itemId);
    });

    // Decrement quantity
    $(".decrement-qty").click(function (e) {
      e.preventDefault();
      var closestInput = $(this).closest(".input-group").find(".qty_input")[0];
      var currentValue = parseInt($(closestInput).val());
      $(closestInput).val(currentValue - 1);
      var itemId = $(this).data("booking_id");
      handleEnableDisable(itemId);
    });
  </script>
  {% endblock %}
</div>
